var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),MapPoint=function(){function e(e,t){this.x=e,this.y=t}return e.prototype.getNeighbor=function(t){return new e(this.x+Direction.getXDelta(t),this.y+Direction.getYDelta(t))},e.prototype.toString=function(){return"MapPoint: "+this.x+"-"+this.y},e.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},e}(),ScreenPoint=function(){function e(e,t){this.x=e,this.y=t}return e}(),Direction;!function(e){e[e.NW=0]="NW",e[e.NE=1]="NE",e[e.SE=2]="SE",e[e.SW=3]="SW"}(Direction||(Direction={})),function(e){function t(e){return(e+1)%4}function n(e){return(e+3)%4}function o(t){switch(t){case e.NW:return-1;case e.SE:return 1;default:return 0}}function i(t){switch(t){case e.NE:return-1;case e.SW:return 1;default:return 0}}e.rotateRight=t,e.rotateLeft=n,e.getXDelta=o,e.getYDelta=i}(Direction||(Direction={}));var CoordinateTransformer=function(){function e(e,t){this.halfTileWidth=e/2,this.halfTileHeight=t/2}return e.prototype.map_to_screen=function(e){var t=(e.x-e.y)*this.halfTileWidth,n=(e.x+e.y)*this.halfTileHeight;return new MapPoint(t,n)},e.prototype.screen_to_map=function(e){var t=(e.x/this.halfTileWidth+e.y/this.halfTileHeight)/2,n=(e.y/this.halfTileHeight-e.x/this.halfTileWidth)/2;return new MapPoint(t,n)},e}(),GnomeCode=function(){function e(e){this.libraries=e}return e.prototype.executeNextCommand=function(e,t){var n=this;t.slice().sort(function(e,t){return e.wateringCan?1:-1}).forEach(function(t){var o=t.codeStack.pop();if(o instanceof RunnableCommand&&o.fn(),void 0===o)return void e.killGnome(t,CauseOfDeath.CODE_RAN_OUT);switch(o.type){case CommandType.WALK:e.tryMove(t);break;case CommandType.LEFT:t.rotateLeft();break;case CommandType.RIGHT:t.rotateRight();break;case CommandType.ACT:e.doGnomeAction(t);break;case CommandType.CALL_ROUTINE:n.queueUpRoutine(e,t,o);break;case CommandType.DELAY:t.delay()}})},e.prototype.queueUpRoutine=function(e,t,n){var o=this.libraries[n.args[0]];if(!o||!o.length)return void e.killGnome(t,CauseOfDeath.CODE_RAN_OUT);for(var i=o.length-1;i>=0;i--)t.codeStack.push(o[i])},e}(),Command=function(){function e(e,t){void 0===t&&(t=[]),this.type=e,this.args=t}return e}(),RunnableCommand=function(e){function t(t){var n=e.call(this,void 0)||this;return n.fn=t,n}return __extends(t,e),t}(Command),CommandType;!function(e){e[e.WALK=0]="WALK",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.ACT=3]="ACT",e[e.CALL_ROUTINE=4]="CALL_ROUTINE",e[e.DELAY=5]="DELAY"}(CommandType||(CommandType={})),function(e){function t(t){switch(t){case e.WALK:return"commandMoveForward";case e.LEFT:return"commandTurnLeft";case e.RIGHT:return"commandTurnRight";case e.ACT:return"commandPerformAction";case e.CALL_ROUTINE:return"commandLibrary";case e.DELAY:return"delay";default:return"unknownCommandType"}}function n(t){switch(t){case"W":return new Command(e.WALK);case"L":return new Command(e.LEFT);case"R":return new Command(e.RIGHT);case"A":return new Command(e.ACT);case"D":return new Command(e.DELAY);default:throw new Error("Cannot parse command "+t)}}e.imageClass=t,e.getCommandTypeForShorthand=n}(CommandType||(CommandType={}));var WorldConstants;!function(e){e.BLOCK_WIDTH=110,e.BLOCK_HEIGHT=68,e.TURN_LENGTH_IN_MILLIS=200,e.COORDINATE_TRANSFORMER=new CoordinateTransformer(e.BLOCK_WIDTH,e.BLOCK_HEIGHT);!function(e){e[e.GRASS=0]="GRASS",e[e.WATER=1]="WATER",e[e.DESERT=2]="DESERT",e[e.STONE=3]="STONE"}(e.BlockType||(e.BlockType={}))}(WorldConstants||(WorldConstants={}));var GNOME_X_OFFSET=60,GNOME_Y_OFFSET=-85,Gnome=function(e){function t(t,n,o,i,a){var s=e.call(this,t,0,0,"gnome_regular_front")||this;s.direction=i,s._wateringCan=!1,s._floating=0,s.codeStack=a.slice(),s.codeStack.reverse(),s.determineSprite(),s.anchor.set(.5,1),s.location=new MapPoint(n,o);var r=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(s.location);return s.x=r.x+GNOME_X_OFFSET,s.y=r.y+GNOME_Y_OFFSET,s.game.add.tween(s).from({alpha:0},500,Phaser.Easing.Quartic.Out,!0),t.add.existing(s),s}return __extends(t,e),Object.defineProperty(t.prototype,"wateringCan",{get:function(){return this._wateringCan},set:function(e){this._wateringCan=e,this.determineSprite()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"floating",{get:function(){return this._floating},set:function(e){!this._floating&&e&&(this.loadTexture("gnome_float_start_front"),this.animations.add("walk"),this.animations.play("walk",10)),this._floating&&!e&&(this.loadTexture("gnome_float_start_front"),this.animations.add("walk",[3,2,1,0]),this.animations.play("walk",10)),this._floating=e},enumerable:!0,configurable:!0}),t.prototype.rotateLeft=function(){this.direction=Direction.rotateLeft(this.direction),this.determineSprite()},t.prototype.rotateRight=function(){this.direction=Direction.rotateRight(this.direction),this.determineSprite()},t.prototype.delay=function(){this.determineSprite()},t.prototype.walkTo=function(e){this.location=e,this.animations.play("walk",30,!0),this.floating&&this.floating--,this.tweenToLocation().start()},t.prototype.die=function(e){var t=this;this.game.tweens.removeFrom(this);var n=this.tweenToLocation();switch(e){case CauseOfDeath.FALLING:n.onChildComplete.add(function(){(t.location.x<0||t.location.y<0)&&t.sendToBack(),t.game.add.sound("falling_gnome_scream").play()}),n.chain().to({y:this.y+500,alpha:0},500,Phaser.Easing.Quartic.In);break;case CauseOfDeath.DROWNING:n.onChildComplete.add(function(){t.loadTexture("gnome_drowning")}),n.to({alpha:0},500,Phaser.Easing.Quartic.Out);break;case CauseOfDeath.CODE_RAN_OUT:n.to({alpha:0},500,Phaser.Easing.Quartic.Out)}n.start(),n.onComplete.add(function(){return t.destroy(!1)},this)},t.prototype.determineSprite=function(){this.direction===Direction.NE||this.direction===Direction.SW?this.scale.x=-1:this.scale.x=1;var e=this.direction===Direction.SE||this.direction===Direction.SW,t=this.wateringCan?"gnome_water":"gnome_regular",n=t+(e?"_front":"_back");this.floating&&(n="gnome_floating_front"),this.loadTexture(n),this.floating?(this.animations.add("walk"),this.animations.play("walk",10,!0)):this.animations.add("walk")},t.prototype.tweenToLocation=function(){var e=this.game.add.tween(this),t=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(this.location);return e.to({x:t.x+GNOME_X_OFFSET,y:t.y+GNOME_Y_OFFSET},WorldConstants.TURN_LENGTH_IN_MILLIS,Phaser.Easing.Linear.None)},t}(Phaser.Sprite),CauseOfDeath;!function(e){e[e.NOTHING=0]="NOTHING",e[e.FALLING=1]="FALLING",e[e.DROWNING=2]="DROWNING",e[e.CODE_RAN_OUT=3]="CODE_RAN_OUT"}(CauseOfDeath||(CauseOfDeath={}));var OBJECT_SPRITE_X_OFFSET=58,OBJECT_SPRITE_Y_OFFSET=-83,GameObject=function(e){function t(t,n,o,i){var a=e.call(this,t,0,0,o)||this;a.model=n,a.passable=i,a.anchor.set(.5,1);var s=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(a.location);return a.x=s.x+OBJECT_SPRITE_X_OFFSET,a.y=s.y+OBJECT_SPRITE_Y_OFFSET,t.add.existing(a),a}return __extends(t,e),Object.defineProperty(t.prototype,"location",{get:function(){return new MapPoint(this.model.positionX,this.model.positionY)},enumerable:!0,configurable:!0}),t.prototype.doAction=function(e){return!1},t}(Phaser.Sprite),ObjectType;!function(e){function t(e,t){switch(t.type){case"TREE":return new Tree(e,t);case"HOUSE":return new House(e,t);case"LIBRARY":return new CodeBuilding(e,t,"library");case"ROCK":return new GameObject(e,t,"rock",!1);case"BUTTON":return new GameObject(e,t,"button",!1);case"MUSHROOMS":return new Mushrooms(e,t);default:throw new Error("Unknown object type "+t.type)}}e.instantiate=t}(ObjectType||(ObjectType={}));var TREE_IMAGE_PREFIX="tree-",MAX_TREE_LEVEL=6,Tree=function(e){function t(t,n){var o=e.call(this,t,n,TREE_IMAGE_PREFIX+"1",!1)||this;return o.model=n,n.treeLevel||(n.treeLevel=1),n.requiredWater||o.calculateRequiredWater(),n.waterContent||(n.waterContent=0),o.calculateRequiredWater(),t.add.existing(o),o}return __extends(t,e),Object.defineProperty(t.prototype,"waterContent",{get:function(){return this.model.waterContent},set:function(e){this.model.waterContent=e,this.displayWaterLevel(),this.model.treeLevel<MAX_TREE_LEVEL&&this.waterContent>=this.model.requiredWater&&(this.model.treeLevel++,this.loadTexture(TREE_IMAGE_PREFIX+this.model.treeLevel),this.waterContent=0,this.calculateRequiredWater())},enumerable:!0,configurable:!0}),t.prototype.doAction=function(e){return!!e.wateringCan&&(this.waterContent=this.waterContent+1,e.wateringCan=!1,!0)},t.prototype.calculateRequiredWater=function(){this.model.treeLevel>=MAX_TREE_LEVEL?this.model.requiredWater=0:this.model.requiredWater=this.model.treeLevel},t.prototype.displayWaterLevel=function(){for(var e=this.y-60,t=this.x-10*this.model.requiredWater,n=this,o=0;o<this.model.requiredWater;o++)!function(o){var i=o<n.model.waterContent?"waterdrop_filled":"waterdrop_empty",a=n.game.add.sprite(t+20*o,e,i),s=n.game.add.tween(a).from({alpha:0},50,null,!0),r=n.game.add.tween(a).to({alpha:0},300,null,!1,1e3);r.onComplete.add(function(){return a.destroy(!1)},n),s.chain(r)}(o)},t}(GameObject),VictoryCondition;!function(e){function t(e,t){if(!t)return!1;for(var n=0,o=t;n<o.length;n++){var i=o[n];if(!e.hasOwnProperty(i.name))return!1;if(i.requirementType&&!(e[i.name]>i.value))return!1}return!0}function n(e,n){for(var o=0,i=0,a=n;i<a.length;i++){var s=a[i];e.entityType===s.type&&(t(s,e.requiredProperties)&&o++)}if(o>=(void 0!==e.amount?e.amount:1))return!0}e.check=n}(VictoryCondition||(VictoryCondition={}));var Messages;!function(e){function t(e,t){var n=new Phaser.Graphics(e);return n.parent=t,n.lineStyle(3,0,1),n.beginFill(16777215),n.drawRoundedRect(0,0,t.width+20,t.height+20,5),n.endFill(),n.moveTo(2,20),n.beginFill(16777215),n.quadraticCurveTo(-10,20,-25,30),n.quadraticCurveTo(-10,20,2,35),n.endFill(),n.x=t.x-10,n.y=t.y-15,n}function n(e,n,s){var r=s||{};i?i.removeAll(!0):i=e.add.group(e.world,"message");var l=i.add(new Phaser.Sprite(e,-200,-280,"gnome_king"));l.animations.add("hover"),l.animations.play("hover",10,!0),e.add.tween(l).to({y:-275},1e3,Phaser.Easing.Sinusoidal.InOut,!0,0,-1).yoyo(!0);var d=i.add(new Phaser.Text(e,-100,-270,n,a)),m=t(e,d);i.add(m,!1,0),d.wordWrapWidth=d.width+10,d.text="";var c=0,u=e.time.events.loop(30,function(){c++,d.text=n.substr(0,c),c>=n.length&&e.time.events.remove(u)});m.inputEnabled=!0;var h=function(){d.text.length<n.length?(d.text=n,e.time.events.remove(u)):(i.removeAll(!0),r.callback&&r.callback())};o(l,h),o(d,h),o(m,h)}function o(e,t){e.inputEnabled=!0,e.input.useHandCursor=!0,e.events.onInputUp.add(t)}var i,a={font:"24px MessageFont",fill:"#000",align:"left",boundsAlignH:"left",boundsAlignV:"top",wordWrap:!0,wordWrapWidth:800};e.show=n}(Messages||(Messages={}));var CodeBuilding=function(e){function t(t,n,o){var i=e.call(this,t,n,o,!1)||this;if(i.model=n,i.inputEnabled=!0,i.input.pixelPerfectClick=!0,i.input.useHandCursor=!0,i.gnomeCode=[],n.initialCode)for(var a=0;a<n.initialCode.length;a++)i.gnomeCode.push(CommandType.getCommandTypeForShorthand(n.initialCode.charAt(a)));return t.add.existing(i),i}return __extends(t,e),t.prototype.select=function(){this.tint=16777045,this.selectionIndicator&&this.selectionIndicator.destroy(),this.selectionIndicator=this.game.add.graphics(0,0),this.selectionIndicator.beginFill(16776960,.4),this.selectionIndicator.moveTo(-WorldConstants.BLOCK_WIDTH/2,-1e3),this.selectionIndicator.lineTo(-WorldConstants.BLOCK_WIDTH/2,-15),this.selectionIndicator.lineTo(0,WorldConstants.BLOCK_HEIGHT/2-15),this.selectionIndicator.lineTo(WorldConstants.BLOCK_WIDTH/2,-15),this.selectionIndicator.lineTo(WorldConstants.BLOCK_WIDTH/2,-1e3),this.selectionIndicator.endFill(),this.addChild(this.selectionIndicator)},t.prototype.deselect=function(){this.tint=16777215,this.selectionIndicator&&this.selectionIndicator.destroy()},t}(GameObject),House=function(e){function t(n,o){var i=e.call(this,n,o,t.determineSprite(o.direction))||this;if(i.model=o,i.inputEnabled=!0,i.input.pixelPerfectClick=!0,i.input.useHandCursor=!0,i.delay=o.delay,i.gnomeCode=[],o.initialCode)for(var a=0;a<o.initialCode.length;a++)i.gnomeCode.push(CommandType.getCommandTypeForShorthand(o.initialCode.charAt(a)));return n.add.existing(i),i}return __extends(t,e),t.determineSprite=function(e){switch(e){case Direction.NE:return"house_ne";case Direction.NW:return"house_nw";case Direction.SE:return"house_se";case Direction.SW:return"house_sw"}},t}(CodeBuilding),GameWorld=function(){function e(e){this.game=e,this.hasWon=!1,this.blockGroup=e.add.group(e.world,"blocks"),this.entityGroup=e.add.group(e.world,"entities"),this.startCodeTimer()}return e.prototype.loadLevel=function(e){var t=this;this.selectedBuilding=null,this.hasWon=!1,this.blockGroup.removeAll(!0),this.entityGroup.removeAll(!0),this.gnomes=[],this.selectionListener&&this.selectionListener();var n=this.game.cache.getJSON(e).LEVEL_DEFINITION;this.level=new Level(n),this.level.renderStage(this.blockGroup),this.level.renderObjects(this.entityGroup),n.introMessage&&Messages.show(this.game,n.introMessage),this.gnomeCode=new GnomeCode(this.level.libraries.map(function(e){return e.gnomeCode})),this.level.codeBuildings.forEach(function(e){e.events.onInputDown.add(function(){t.selectedBuilding&&t.selectedBuilding.deselect(),t.selectedBuilding=e,t.selectedBuilding.select(),t.selectionListener&&t.selectionListener(e,t.level.libraries)})}),this.determineEntityZIndices()},e.prototype.doGnomeAction=function(e){var t=e.location.getNeighbor(e.direction),n=this.level.getBlock(t),o=this.gnomes.filter(function(e){return e.location.equals(t)}),i=o[0];this.level.doObjectAction(t,e)||(e.floating||n!==WorldConstants.BlockType.WATER||(e.wateringCan=!0),!e.floating&&this.getIfAdjacent(e,i)&&e.wateringCan&&(e.wateringCan=!1,i.wateringCan=!0))},e.prototype.getIfAdjacent=function(e,t){return!!t&&(t.direction+2)%4===e.direction},e.prototype.tryMove=function(e){var t=e.location.getNeighbor(e.direction);if(!this.gnomes.filter(function(e){return e.location.equals(t)}).length&&this.level.pointIsPassable(t)&&(e.walkTo(t),this.determineEntityZIndices()),!e.floating){var n=this.level.getPointCauseOfDeath(t);n&&this.killGnome(e,n)}},e.prototype.killGnome=function(e,t){this.gnomes.splice(this.gnomes.indexOf(e),1),this.entityGroup.remove(e),this.game.world.add(e),e.die(t)},e.prototype.spawnGnomes=function(){var e=this;this.level.houses.forEach(function(t){var n=new Gnome(e.game,t.model.positionX+Direction.getXDelta(t.model.direction),t.model.positionY+Direction.getYDelta(t.model.direction),t.model.direction,e.addDelay(t.gnomeCode,t.delay));e.entityGroup.add(n),e.gnomes.push(n),e.determineEntityZIndices()})},e.prototype.addDelay=function(e,t){for(var n=[],o=0;o<t;o++)n.push(new Command(CommandType.DELAY));return n.concat(e)},e.prototype.determineEntityZIndices=function(){this.entityGroup.customSort(function(e,t){var n=e.location.x+e.location.y,o=t.location.x+t.location.y;return n>o?1:n<o?-1:0})},e.prototype.startCodeTimer=function(){var e=this,t=this.game.time.create();t.loop(WorldConstants.TURN_LENGTH_IN_MILLIS,function(){e.gnomeCode.executeNextCommand(e,e.gnomes),!e.hasWon&&e.level.checkVictory()&&e.winLevel()}),t.start()},e.prototype.winLevel=function(){var e=this;this.hasWon=!0,Messages.show(this.game,"Good work! Click here to continue",{callback:function(){e.level.nextLevel?e.loadLevel(e.level.nextLevel):e.game.state.start("menu")}})},e}(),WATERFALL_X_OFFSET_RIGHT=47,WATERFALL_X_OFFSET_LEFT=67,WATERFALL_Y_OFFSET=-97,Level=function(){function e(e){this.objectMap={},this.houses=[],this.codeBuildings=[],this.libraries=[];var t=JSON.parse(JSON.stringify(e));this.layout=t.layout,this.objectModels=t.objects,this.victoryConditions=t.victoryConditions,this.nextLevel=t.nextLevel}return e.prototype.pointIsPassable=function(e){var t=this.getObject(e);return!t||t.passable},e.prototype.getPointCauseOfDeath=function(e){var t=this.getBlock(e);return null===t?CauseOfDeath.FALLING:t===WorldConstants.BlockType.WATER?CauseOfDeath.DROWNING:CauseOfDeath.NOTHING},e.prototype.getBlock=function(e){return void 0===this.layout[e.y]||void 0===this.layout[e.y][e.x]?null:this.layout[e.y][e.x]},e.prototype.getObject=function(e){return this.objectMap[e.toString()]},e.prototype.checkVictory=function(){if(!this.victoryConditions)return!1;for(var e=0,t=this.victoryConditions;e<t.length;e++){var n=t[e];if(!VictoryCondition.check(n,this.objectModels))return!1}return!0},e.prototype.doObjectAction=function(e,t){var n=this.objectMap[e.toString()];return!!n&&n.doAction(t)},e.prototype.renderStage=function(e){for(var t=this.layout.length,n=this.layout[0].length,o=0;o<t;o++)for(var i=0;i<n;i++){var a=this.layout[o][i];this.renderBlock(e,i,o,a),a===WorldConstants.BlockType.WATER&&(o===t-1&&this.renderWaterFall(e,i,o,!0),i===n-1&&this.renderWaterFall(e,i,o,!1))}},e.prototype.renderObjects=function(e){for(var t=0;t<this.objectModels.length;t++){var n=this.objectModels[t],o=this.renderObject(e.game,n);e.add(o),this.objectMap[new MapPoint(n.positionX,n.positionY).toString()]=o}},e.prototype.renderObject=function(e,t){var n=ObjectType.instantiate(e,t);return n instanceof House&&this.houses.push(n),n instanceof CodeBuilding&&(this.codeBuildings.push(n),"LIBRARY"===n.model.type&&this.libraries.push(n)),n},e.prototype.renderBlock=function(e,t,n,o){var i=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(new MapPoint(t,n)),a=e.game.add.sprite(i.x,i.y,this.getBlockSprite(o));a.anchor.y=1,e.add(a)},e.prototype.renderWaterFall=function(e,t,n,o){var i=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(new MapPoint(t,n)),a=new Phaser.Sprite(e.game,i.x+(o?WATERFALL_X_OFFSET_LEFT:WATERFALL_X_OFFSET_RIGHT),i.y+WATERFALL_Y_OFFSET,"waterfall");a.anchor.y=0,a.anchor.x=0,o&&(a.scale.x=-1),a.animations.add("flow"),a.alpha=.5,a.animations.play("flow",10,!0),e.add(a)},e.prototype.getBlockSprite=function(e){switch(e){case WorldConstants.BlockType.GRASS:return"stage_block";case WorldConstants.BlockType.WATER:return"water_block";case WorldConstants.BlockType.DESERT:return"desert_block";case WorldConstants.BlockType.STONE:return"stone_block";default:return"stage_block"}},e}(),States;!function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(e){this.initialLevel=e||"tutorial_level_1"},n.prototype.create=function(){var t=this;this.game.camera.setPosition(-400,-300),this.initializeEditor(),this.drawSpawnButton(),document.getElementById("innerCodeEditor").addEventListener("click",function(e){return t.handleCommandClick(e)}),this.gameWorld=new GameWorld(this.game),this.gameWorld.selectionListener=function(n,o){t.selectedCodeBuilding=n,e.PlayState.cleanupCommandButtonBar(),n&&t.initializeButtons(o),t.showCodeInEditor()},this.gameWorld.loadLevel(this.initialLevel)},n.prototype.shutdown=function(){e.PlayState.cleanupCommandButtonBar();var t=document.getElementById("gnomeCodeEditor");t.style.display="none";var n=t.cloneNode(!0);t.parentNode.replaceChild(n,t)},n.cleanupCommandButtonBar=function(){var e=document.getElementById("gnomeCodeButtons"),t=e.cloneNode();e.parentNode.replaceChild(t,e),e.style.display="none"},n.prototype.initializeButtons=function(e){var t=this,o=document.getElementById("gnomeCodeButtons");o.style.display="block",o.addEventListener("click",function(e){return t.handleCommandButtonClick(e)}),Sortable.create(o,{group:{name:"gnomeCode",pull:"clone",put:!1},sort:!1}),n.appendCommandToGui(o,CommandType.WALK),n.appendCommandToGui(o,CommandType.LEFT),n.appendCommandToGui(o,CommandType.RIGHT),n.appendCommandToGui(o,CommandType.ACT);for(var i=0;i<e.length;i++)n.appendCommandToGui(o,CommandType.CALL_ROUTINE,i)},n.prototype.initializeEditor=function(){var e=this,t=document.getElementById("innerCodeEditor");this.codeEditorSortable=Sortable.create(t,{group:{name:"gnomeCode",pull:!1,put:!0},animation:150,filter:".commandPlaceholder",onSort:function(o){var i=e.selectedCodeBuilding.gnomeCode,a="innerCodeEditor"===o.from.id?i.splice(o.oldIndex,1)[0]:e.parseCommandFromMouseEvent(o);if(i.splice(o.newIndex,0,a),n.removePlaceholders(t),i.length>e.selectedCodeBuilding.model.sizeLimit)for(i.splice(e.selectedCodeBuilding.model.sizeLimit);t.children.length>e.selectedCodeBuilding.model.sizeLimit;)t.removeChild(t.children.item(e.selectedCodeBuilding.model.sizeLimit));n.appendPlaceholders(t,e.selectedCodeBuilding.model.sizeLimit-i.length)}})},n.prototype.parseCommandFromMouseEvent=function(e){var t=parseInt(e.item.dataset.commandType);return e.item.dataset.libraryIndex?new Command(t,[parseInt(e.item.dataset.libraryIndex)]):new Command(t)},n.prototype.showCodeInEditor=function(){var e=document.getElementById("gnomeCodeEditor");if(e.style.display=this.selectedCodeBuilding?"block":"none",this.selectedCodeBuilding){e.classList.toggle("readonly",this.selectedCodeBuilding.model.readonly),e.classList.toggle("editable",!this.selectedCodeBuilding.model.readonly),this.updateCommandsLabel();var t=document.getElementById("innerCodeEditor");t.innerHTML="",this.codeEditorSortable.options.disabled=this.selectedCodeBuilding.model.readonly,this.selectedCodeBuilding.gnomeCode.forEach(function(e){n.appendCommandToGui(t,e.type)}),n.appendPlaceholders(t,this.selectedCodeBuilding.model.sizeLimit-this.selectedCodeBuilding.gnomeCode.length)}},n.prototype.updateCommandsLabel=function(){var e=document.getElementById("codeEditorLabel");if(this.selectedCodeBuilding.model.readonly)"LIBRARY"===this.selectedCodeBuilding.model.type?e.innerText="This library routine can't be changed":e.innerText="This gnome's routine can't be changed";else{var t=this.selectedCodeBuilding.gnomeCode.length;t=t>0?t:0,this.selectedCodeBuilding.delay?e.innerText="This building has a delay of "+this.selectedCodeBuilding.delay:e.innerText="",n.appendPlaceholders(document.getElementById("innerCodeEditor"),this.selectedCodeBuilding.model.sizeLimit-t)}},n.prototype.drawSpawnButton=function(){var e=this;this.drawButton(94,10,"play_button",function(){return e.gameWorld.spawnGnomes()})},n.prototype.drawButton=function(e,t,n,o){var i=this.game.add.sprite(e,t,n);return i.inputEnabled=!0,i.fixedToCamera=!0,i.events.onInputDown.add(o,this),i.input.useHandCursor=!0,i},n.prototype.handleCommandButtonClick=function(e){var t=e.target;if(!(!t.classList.contains("commandButton")||this.selectedCodeBuilding.model.readonly||this.selectedCodeBuilding.gnomeCode.length>=this.selectedCodeBuilding.model.sizeLimit)){var o=parseInt(t.dataset.commandType),i=t.dataset.libraryIndex?new Command(o,[parseInt(t.dataset.libraryIndex)]):new Command(o);this.selectedCodeBuilding.gnomeCode.push(i),n.removePlaceholders(document.getElementById("innerCodeEditor")),n.appendCommandToGui(document.getElementById("innerCodeEditor"),o),this.updateCommandsLabel()}},n.prototype.handleCommandClick=function(e){var t=e.target;if(t.classList.contains("commandButton")&&!t.classList.contains("commandPlaceholder")&&!this.selectedCodeBuilding.model.readonly){var o=document.getElementById("innerCodeEditor"),i=Array.prototype.indexOf.call(o.children,t);this.selectedCodeBuilding.gnomeCode.splice(i,1),n.removePlaceholders(document.getElementById("innerCodeEditor")),o.removeChild(t),this.updateCommandsLabel()}},n.appendCommandToGui=function(e,t,n){var o=document.createElement("DIV");o.classList.add("commandButton"),o.dataset.commandType=t.toString(),o.classList.add(CommandType.imageClass(t)),void 0!==n&&(o.dataset.libraryIndex=n.toString()),e.appendChild(o)},n.removePlaceholders=function(e){for(var t=e.getElementsByClassName("commandPlaceholder"),n=t.length-1;n>=0;n--)e.removeChild(t[n])},n.appendPlaceholders=function(e,t){for(var n=0;n<t;n++){var o=document.createElement("DIV");o.classList.add("commandButton"),o.classList.add("commandPlaceholder"),e.appendChild(o)}},n}(Phaser.State);e.PlayState=t}(States||(States={}));var States;!function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.preload=function(){var e=this.game.width/2,t=this.game.height/2;this.game.add.sprite(e,t,"logo").anchor.set(.5);var n=this.game.add.sprite(e,t+100,"progressBar");n.anchor.set(.5),this.load.setPreloadSprite(n),this.load.image("stage_block","assets/images/stage_block.png"),this.load.image("water_block","assets/images/water_block.png"),this.load.image("desert_block","assets/images/desert_block.png"),this.load.image("stone_block","assets/images/stone_block.png"),this.load.spritesheet("gnome_regular_front","assets/images/gnome_regular_front.png",70,100),this.load.spritesheet("gnome_regular_back","assets/images/gnome_regular_back.png",70,100),this.load.spritesheet("gnome_water_front","assets/images/gnome_water_front.png",70,100),this.load.spritesheet("gnome_water_back","assets/images/gnome_water_back.png",70,100),this.load.spritesheet("gnome_float_start_front","assets/images/gnome_float_start_front.png",70,150),this.load.spritesheet("gnome_floating_front","assets/images/gnome_floating_front.png",70,150),this.load.image("gnome_drowning","assets/images/gnome_drowning.png"),this.load.image("main_menu_options","assets/images/main-menu-options.png"),this.load.image("main_menu_continue","assets/images/main-menu-continue.png"),this.load.image("main_menu_start","assets/images/main-menu-start.png"),this.load.image("play_button","assets/images/play_button.png"),this.load.image("tree-1","assets/images/tree-1.png"),this.load.image("tree-2","assets/images/tree-2.png"),this.load.image("tree-3","assets/images/tree-3.png"),this.load.image("tree-4","assets/images/tree-4.png"),this.load.image("tree-5","assets/images/tree-5.png"),this.load.image("tree-6","assets/images/tree-6.png"),this.load.image("house_ne","assets/images/house_back_right.png"),this.load.image("house_nw","assets/images/house_back_left.png"),this.load.image("house_se","assets/images/house_front_right.png"),this.load.image("house_sw","assets/images/house_front_left.png"),this.load.image("mushrooms_0","assets/images/mushrooms_0.png"),this.load.image("mushrooms_1","assets/images/mushrooms_1.png"),this.load.image("mushrooms_2","assets/images/mushrooms_2.png"),this.load.image("mushrooms_3","assets/images/mushrooms_3.png"),this.load.image("rock","assets/images/rock.png"),this.load.image("library","assets/images/library.png"),this.load.image("button","assets/images/action-button.png"),this.load.image("waterdrop_empty","assets/images/waterdrop_empty.png"),this.load.image("waterdrop_filled","assets/images/waterdrop_filled.png"),this.load.spritesheet("waterfall","assets/images/waterfall.png",80,240),this.load.spritesheet("gnome_king","assets/images/gnome_king.png",70,100),this.load.audio("falling_gnome_scream","assets/sound/wilhelm_scream.ogg"),this.load.json("tutorial_level_1","assets/levels/tutorial_level_1.json"),this.load.json("tutorial_level_2","assets/levels/tutorial_level_2.json"),this.load.json("tutorial_level_3","assets/levels/tutorial_level_3.json"),this.load.json("tutorial_level_4","assets/levels/tutorial_level_4.json"),this.load.json("tutorial_level_5","assets/levels/tutorial_level_5.json"),this.load.json("tutorial_level_6","assets/levels/tutorial_level_6.json"),this.load.json("menu_level","assets/levels/menu_level.json"),this.load.json("test","assets/levels/example_level.json")},t.prototype.create=function(){var e=this;this.game.time.events.add(0,function(){e.game.state.start("menu")},this)},t}(Phaser.State);e.PreloadState=t}(States||(States={}));var States;!function(e){var t={font:"32px Arial",fill:"#ff0044",align:"center"},n=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.prototype.create=function(){this.game.camera.setPosition(-400,-300),this.gameWorld=new GameWorld(this.game),this.gameWorld.loadLevel("menu_level"),this.createMenuButton("Continue",0,-250,this.continueGame),this.createMenuButton("Start Game",-250,200,this.startGame),this.createMenuButton("Options",250,-120,this.options),this.createMenuImage(250,-75,"main_menu_options"),this.createMenuImage(-250,150,"main_menu_start"),this.createMenuImage(-90,-210,"main_menu_continue")},n.prototype.createMenuButton=function(e,n,o,i){var a=this.game.add.text(n,o,e,t);return a.inputEnabled=!0,a.input.useHandCursor=!0,a.events.onInputUp.add(i,this),a},n.prototype.createMenuImage=function(e,t,n){var o=this.game.add.image(e,t,n);return o.scale.set(.5,.5),o},n.prototype.startGame=function(){var e=this;this.gameWorld.level.houses[0].gnomeCode=[new Command(CommandType.WALK),new Command(CommandType.WALK),new Command(CommandType.ACT),new RunnableCommand(function(){e.game.state.start("play")})],this.gameWorld.spawnGnomes()},n.prototype.continueGame=function(){var e=this;this.gameWorld.level.houses[0].gnomeCode=[new Command(CommandType.WALK),new Command(CommandType.RIGHT),new Command(CommandType.WALK),new Command(CommandType.WALK),new Command(CommandType.RIGHT),new Command(CommandType.WALK),new Command(CommandType.ACT),new RunnableCommand(function(){var t=prompt("Continue from which level?","tutorial_level_5");t&&e.game.state.start("play",!0,!1,t)})],this.gameWorld.spawnGnomes()},n.prototype.options=function(){this.gameWorld.level.houses[0].gnomeCode=[new Command(CommandType.WALK),new Command(CommandType.LEFT),new Command(CommandType.WALK),new Command(CommandType.WALK),new Command(CommandType.LEFT),new Command(CommandType.WALK),new Command(CommandType.ACT)],this.gameWorld.spawnGnomes(),console.log("options")},n}(Phaser.State);e.MenuState=n}(States||(States={}));var States;!function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){this.scale.scaleMode=Phaser.ScaleManager.RESIZE,this.game.camera.bounds=null},n.prototype.preload=function(){this.game.load.image("progressBar","assets/images/progressbar.png"),this.game.load.image("logo","assets/images/logo.png"),this.game.state.add("preload",e.PreloadState),this.game.state.add("menu",e.MenuState),this.game.state.add("play",e.PlayState)},n.prototype.create=function(){this.game.state.start("preload")},n}(Phaser.State);e.BootState=t}(States||(States={}));var Game=function(e){function t(){return e.call(this,"100","100",Phaser.AUTO,"content",null,!0)||this}return __extends(t,e),t.prototype.start=function(){this.state.add("boot",States.BootState,!0)},t}(Phaser.Game);window.codeGarden=new Game;var Mushrooms=function(e){function t(t,n){var o=e.call(this,t,n,"mushrooms_"+n.amount,!0)||this;return o.model=n,o}return __extends(t,e),t.prototype.doAction=function(e){return!(!this.model.amount&&!e.wateringCan)&&(e.wateringCan?(e.wateringCan=!1,this.model.amount<3&&this.model.amount++):(e.floating=2,this.model.amount--),this.loadTexture("mushrooms_"+this.model.amount),!0)},t}(GameObject);