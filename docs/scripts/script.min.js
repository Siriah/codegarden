var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),MapPoint=function(){function e(e,t){this.x=e,this.y=t}return e.prototype.getNeighbor=function(t){return new e(this.x+Direction.getXDelta(t),this.y+Direction.getYDelta(t))},e.prototype.toString=function(){return"MapPoint: "+this.x+"-"+this.y},e.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},e}(),ScreenPoint=function(){function e(e,t){this.x=e,this.y=t}return e}(),Direction;!function(e){e[e.NW=0]="NW",e[e.NE=1]="NE",e[e.SE=2]="SE",e[e.SW=3]="SW"}(Direction||(Direction={})),function(e){function t(e){return(e+1)%4}function n(e){return(e+3)%4}function o(t){switch(t){case e.NW:return-1;case e.SE:return 1;default:return 0}}function i(t){switch(t){case e.NE:return-1;case e.SW:return 1;default:return 0}}e.rotateRight=t,e.rotateLeft=n,e.getXDelta=o,e.getYDelta=i}(Direction||(Direction={}));var CoordinateTransformer=function(){function e(e,t){this.halfTileWidth=e/2,this.halfTileHeight=t/2}return e.prototype.map_to_screen=function(e){var t=(e.x-e.y)*this.halfTileWidth,n=(e.x+e.y)*this.halfTileHeight;return new MapPoint(t,n)},e.prototype.screen_to_map=function(e){var t=(e.x/this.halfTileWidth+e.y/this.halfTileHeight)/2,n=(e.y/this.halfTileHeight-e.x/this.halfTileWidth)/2;return new MapPoint(t,n)},e}(),GnomeCode=function(){function e(e){this.libraries=e}return e.prototype.executeNextCommand=function(e,t){var n=this,o=[],i=[];t.slice().sort(function(e,t){return e.wateringCan?1:-1}).forEach(function(t){if(t.delayed)return void t.delayed--;var a=t.codeStack.pop();if(a instanceof RunnableCommand&&a.fn(),void 0===a)i.push({gnome:t,reason:CauseOfDeath.CODE_RAN_OUT});else{if(a.type!==CommandType.WALK){var r=e.level.getPointCauseOfDeath(t.location,!1);r&&i.push({gnome:t,reason:r})}switch(a.type){case CommandType.WALK:o.push(t);break;case CommandType.LEFT:t.rotateLeft();break;case CommandType.RIGHT:t.rotateRight();break;case CommandType.ACT:e.doGnomeAction(t);break;case CommandType.CALL_ROUTINE:t.readBook(),n.queueUpRoutine(t,a)||i.push({gnome:t,reason:CauseOfDeath.CODE_RAN_OUT});break;case CommandType.DELAY:t.delay()}}}),o.forEach(function(t){var n=e.tryMove(t),o=e.level.getPointCauseOfDeath(t.location,n);o&&i.push({gnome:t,reason:o})}),i.forEach(function(t){(!t.gnome.floating||t.reason!==CauseOfDeath.FALLING&&t.reason!==CauseOfDeath.DROWNING)&&e.killGnome(t.gnome,t.reason)})},e.prototype.queueUpRoutine=function(e,t){var n=this.libraries[t.args[0]];if(!n||!n.length)return!1;for(var o=n.length-1;o>=0;o--)e.codeStack.push(n[o]);return!0},e}(),Command=function(){function e(e,t){void 0===t&&(t=[]),this.type=e,this.args=t}return e}(),RunnableCommand=function(e){function t(t){var n=e.call(this,void 0)||this;return n.fn=t,n}return __extends(t,e),t}(Command),CommandType;!function(e){e[e.WALK=0]="WALK",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.ACT=3]="ACT",e[e.CALL_ROUTINE=4]="CALL_ROUTINE",e[e.DELAY=5]="DELAY"}(CommandType||(CommandType={})),function(e){function t(t){switch(t){case e.WALK:return"commandMoveForward";case e.LEFT:return"commandTurnLeft";case e.RIGHT:return"commandTurnRight";case e.ACT:return"commandPerformAction";case e.CALL_ROUTINE:return"commandLibrary";case e.DELAY:return"delay";default:return"unknownCommandType"}}function n(t){switch(t){case"W":return new Command(e.WALK);case"L":return new Command(e.LEFT);case"R":return new Command(e.RIGHT);case"A":return new Command(e.ACT);case"D":return new Command(e.DELAY);default:throw new Error("Cannot parse command "+t)}}function o(t){switch(t){case e.WALK:return"Move forward";case e.LEFT:return"Turn left";case e.RIGHT:return"Turn right";case e.ACT:return"Interact with whatever the gnome is looking at";case e.CALL_ROUTINE:return"Read a book from the corresponding library and do what it says"}return"What does this command do? It's a mystery to everyone!"}e.imageClass=t,e.getCommandTypeForShorthand=n,e.getTooltip=o}(CommandType||(CommandType={}));var WorldConstants;!function(e){e.SPRITE_SHEET="sprites",e.BLOCK_WIDTH=110,e.BLOCK_HEIGHT=68,e.TURN_LENGTH_IN_MILLIS=200,e.COORDINATE_TRANSFORMER=new CoordinateTransformer(e.BLOCK_WIDTH,e.BLOCK_HEIGHT);!function(e){e[e.GRASS=0]="GRASS",e[e.WATER=1]="WATER",e[e.DESERT=2]="DESERT",e[e.STONE=3]="STONE",e[e.SWAMP=4]="SWAMP"}(e.BlockType||(e.BlockType={}))}(WorldConstants||(WorldConstants={}));var GNOME_X_OFFSET=60,GNOME_Y_OFFSET=-85,FLOATING_ANIMATION_FRAMERATE=10,WALKING_ANIMATION_FRAMERATE=30,Gnome=function(e){function t(t,n,o,i,a){var r=e.call(this,t,0,0,WorldConstants.SPRITE_SHEET)||this;r.direction=i,r.delayed=0,r._wateringCan=!1,r._floating=0,r.codeStack=a.slice(),r.codeStack.reverse(),r.registerAnimations(),r.determineSprite(),r.anchor.set(.5,1),r.location=new MapPoint(n,o);var s=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(r.location);return r.x=s.x+GNOME_X_OFFSET,r.y=s.y+GNOME_Y_OFFSET,t.add.existing(r),r}return __extends(t,e),Object.defineProperty(t.prototype,"wateringCan",{get:function(){return this._wateringCan},set:function(e){this._wateringCan=e,this.determineSprite()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"floating",{get:function(){return this._floating},set:function(e){!this._floating&&e&&this.animations.play("float_start"),this._floating&&!e&&this.animations.play("float_stop"),this._floating=e},enumerable:!0,configurable:!0}),t.prototype.registerAnimations=function(){this.animations.add("floating",Phaser.Animation.generateFrameNames("gnome_floating_front_",0,3),FLOATING_ANIMATION_FRAMERATE,!0),this.animations.add("float_start",Phaser.Animation.generateFrameNames("gnome_float_start_front_",0,3),FLOATING_ANIMATION_FRAMERATE),this.animations.add("float_stop",Phaser.Animation.generateFrameNames("gnome_float_start_front_",3,0),FLOATING_ANIMATION_FRAMERATE),this.animations.add("gnome_regular_walk_front",Phaser.Animation.generateFrameNames("gnome_regular_walk_front_",0,3),WALKING_ANIMATION_FRAMERATE),this.animations.add("gnome_regular_walk_back",Phaser.Animation.generateFrameNames("gnome_regular_walk_back_",0,3),WALKING_ANIMATION_FRAMERATE),this.animations.add("gnome_wateringcan_walk_front",Phaser.Animation.generateFrameNames("gnome_wateringcan_walk_front_",0,3),WALKING_ANIMATION_FRAMERATE),this.animations.add("gnome_wateringcan_walk_back",Phaser.Animation.generateFrameNames("gnome_wateringcan_walk_back_",0,3),WALKING_ANIMATION_FRAMERATE)},t.prototype.rotateLeft=function(){this.direction=Direction.rotateLeft(this.direction),this.determineSprite()},t.prototype.rotateRight=function(){this.direction=Direction.rotateRight(this.direction),this.determineSprite()},t.prototype.delay=function(){this.frameName="gnome_waiting"},t.prototype.readBook=function(){this.floating||(this.frameName="gnome_reading")},t.prototype.walkTo=function(e){this.location=e,this.determineSprite(!0),this.animations.play("walk",30,!0),this.floating&&this.floating--,this.tweenToLocation().start()},t.prototype.die=function(e){var t=this;this.game.tweens.removeFrom(this);var n=this.tweenToLocation();switch(e){case CauseOfDeath.FALLING:n.onChildComplete.add(function(){(t.location.x<0||t.location.y<0)&&t.sendToBack(),t.game.add.sound("falling_gnome_scream").play()}),n.chain().to({y:this.y+500,alpha:0},500,Phaser.Easing.Quartic.In);break;case CauseOfDeath.DROWNING:n.onChildComplete.add(function(){t.frameName="gnome_drowning",t.game.add.sound("bubbles").play()}),n.to({alpha:0},500,Phaser.Easing.Quartic.Out);break;case CauseOfDeath.CACTUS:n.onComplete.add(function(){var e=t.game.add.emitter(t.x,t.y-30,20);e.makeParticles(WorldConstants.SPRITE_SHEET,"beard_particle"),e.gravity=-30,e.setAlpha(1,0,1500,Phaser.Easing.Sinusoidal.Out),e.start(!0,1500,null,20)});break;case CauseOfDeath.CODE_RAN_OUT:n.to({alpha:0},500,Phaser.Easing.Quartic.Out)}n.start(),n.onComplete.add(function(){return t.destroy(!1)},this)},t.prototype.determineSprite=function(e){if(void 0===e&&(e=!1),this.direction===Direction.NE||this.direction===Direction.SW?this.scale.x=-1:this.scale.x=1,this.floating)return void this.animations.play("floating");var t=this.direction===Direction.SE||this.direction===Direction.SW,n=this.wateringCan?"gnome_wateringcan_walk_":"gnome_regular_walk_",o=n+(t?"front":"back");e?this.animations.play(o):this.frameName=o+"_0"},t.prototype.tweenToLocation=function(){var e=this.game.add.tween(this),t=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(this.location);return e.to({x:t.x+GNOME_X_OFFSET,y:t.y+GNOME_Y_OFFSET},WorldConstants.TURN_LENGTH_IN_MILLIS,Phaser.Easing.Linear.None)},t}(Phaser.Sprite),CauseOfDeath;!function(e){e[e.NOTHING=0]="NOTHING",e[e.FALLING=1]="FALLING",e[e.DROWNING=2]="DROWNING",e[e.CODE_RAN_OUT=3]="CODE_RAN_OUT",e[e.CACTUS=4]="CACTUS"}(CauseOfDeath||(CauseOfDeath={}));var OBJECT_SPRITE_X_OFFSET=58,OBJECT_SPRITE_Y_OFFSET=-83,GameObject=function(e){function t(t,n,o,i,a){void 0===a&&(a=CauseOfDeath.NOTHING);var r=e.call(this,t,0,0,WorldConstants.SPRITE_SHEET,o)||this;r.model=n,r.passable=i,r.causeOfDeath=a,r.initialModel=JSON.parse(JSON.stringify(n)),r.anchor.set(.5,1);var s=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(r.location);return r.x=s.x+OBJECT_SPRITE_X_OFFSET,r.y=s.y+OBJECT_SPRITE_Y_OFFSET,r.allowSeeingBehindObject(),t.add.existing(r),r}return __extends(t,e),Object.defineProperty(t.prototype,"location",{get:function(){return new MapPoint(this.model.positionX,this.model.positionY)},enumerable:!0,configurable:!0}),t.prototype.allowSeeingBehindObject=function(){var e=this;this.inputEnabled=!0,this.input.pixelPerfectOver=!0,this.input.pixelPerfectClick=!0;var t=null,n=null;this.events.onInputOver.add(function(){t&&(t.stop(),t=null),n||(n=e.game.add.tween(e).to({alpha:.6},1e3,Phaser.Easing.Sinusoidal.InOut,!0))},this),this.events.onInputOut.add(function(){n&&(n.stop(),n=null),t||(t=e.game.add.tween(e).to({alpha:1},300,Phaser.Easing.Sinusoidal.InOut,!0))},this)},t.prototype.doAction=function(e){return!1},t.prototype.softReset=function(){for(var e in this.initialModel)this.initialModel.hasOwnProperty(e)&&(this.model[e]=this.initialModel[e]);this.updateTexture()},t.prototype.updateTexture=function(){var e=this.determineTexture();e&&this.loadTexture(WorldConstants.SPRITE_SHEET,e)},t.prototype.determineTexture=function(){return null},t}(Phaser.Sprite),ObjectType;!function(e){function t(e,t,n){switch(t.type){case"CACTUS":return new GameObject(e,t,"cactus",!0,CauseOfDeath.CACTUS);case"TREE":return new Tree(e,t);case"HOUSE":return new House(e,t);case"LIBRARY":return new CodeBuilding(e,t,"library-"+CodeBuilding.getLibraryColor(n));case"ROCK":return new GameObject(e,t,"rock",!1);case"BUTTON":return new GameObject(e,t,"action_button",!1);case"MUSHROOMS":return new Mushrooms(e,t);default:throw new Error("Unknown object type "+t.type)}}e.instantiate=t}(ObjectType||(ObjectType={}));var TREE_IMAGE_PREFIX="tree-",MAX_TREE_LEVEL=6,Tree=function(e){function t(n,o){var i=e.call(this,n,t.addDefaults(o),TREE_IMAGE_PREFIX+"1",!1)||this;return i.model=o,i.calculateRequiredWater(),n.add.existing(i),i}return __extends(t,e),Object.defineProperty(t.prototype,"waterContent",{get:function(){return this.model.waterContent},set:function(e){this.model.waterContent=e,this.displayWaterLevel(),this.model.treeLevel<MAX_TREE_LEVEL&&this.waterContent>=this.model.requiredWater&&(this.model.treeLevel++,this.updateTexture(),this.waterContent=0,this.calculateRequiredWater())},enumerable:!0,configurable:!0}),t.prototype.determineTexture=function(){return TREE_IMAGE_PREFIX+this.model.treeLevel},t.addDefaults=function(e){return e.treeLevel||(e.treeLevel=1),e.waterContent||(e.waterContent=0),e.requiredWater||(e.requiredWater=e.treeLevel>=MAX_TREE_LEVEL?0:e.treeLevel),e},t.prototype.doAction=function(e){return!!e.wateringCan&&(this.waterContent=this.waterContent+1,e.wateringCan=!1,!0)},t.prototype.calculateRequiredWater=function(){this.model.treeLevel>=MAX_TREE_LEVEL?this.model.requiredWater=0:this.model.requiredWater=this.model.treeLevel},t.prototype.displayWaterLevel=function(){for(var e=this.y-60,t=this.x-10*this.model.requiredWater,n=this,o=0;o<this.model.requiredWater;o++)!function(o){var i=o<n.model.waterContent?"waterdrop_filled":"waterdrop_empty",a=n.game.add.sprite(t+20*o,e,WorldConstants.SPRITE_SHEET,i),r=n.game.add.tween(a).from({alpha:0},50,null,!0),s=n.game.add.tween(a).to({alpha:0},300,null,!1,1e3);s.onComplete.add(function(){return a.destroy(!1)},n),r.chain(s)}(o)},t}(GameObject),VictoryCondition;!function(e){function t(e,t){if(!t)return!1;for(var n=0,o=t;n<o.length;n++){var i=o[n];if(!e.hasOwnProperty(i.name))return!1;if(i.requirementType&&!(e[i.name]>i.value))return!1}return!0}function n(e,n){for(var o=0,i=0,a=n;i<a.length;i++){var r=a[i];e.entityType===r.type&&(t(r,e.requiredProperties)&&o++)}if(o>=(void 0!==e.amount?e.amount:1))return!0}e.check=n}(VictoryCondition||(VictoryCondition={}));var Messages;!function(e){function t(e,t){var n=new Phaser.Graphics(e);return n.parent=t,n.lineStyle(3,0,1),n.beginFill(16777215),n.drawRoundedRect(0,0,t.width+20,t.height+20,5),n.endFill(),n.moveTo(2,20),n.beginFill(16777215),n.quadraticCurveTo(-10,20,-25,30),n.quadraticCurveTo(-10,20,2,35),n.endFill(),n.x=t.x-10,n.y=t.y-15,n}function n(e,n,r){var s=r||{};i&&i.destroy(),i=e.add.group(e.world,"message");var d=i.add(new Phaser.Sprite(e,-200,-280,WorldConstants.SPRITE_SHEET));d.animations.add("hover",Phaser.Animation.generateFrameNames("gnome_king_",0,3)),d.animations.play("hover",10,!0),e.add.tween(d).to({y:-275},1e3,Phaser.Easing.Sinusoidal.InOut,!0,0,-1).yoyo(!0);var l=i.add(new Phaser.Text(e,-100,-270,n,a)),c=t(e,l);i.add(c,!1,0),l.wordWrapWidth=l.width+10,l.text="";var u=0,m=e.time.events.loop(30,function(){u++,l.text=n.substr(0,u),u>=n.length&&e.time.events.remove(m)});c.inputEnabled=!0;var h=function(){l.text.length<n.length?(l.text=n,e.time.events.remove(m)):(i.removeAll(!0),s.callback&&s.callback())};o(d,h),o(l,h),o(c,h)}function o(e,t){e.inputEnabled=!0,e.input.useHandCursor=!0,e.events.onInputUp.add(t)}var i,a={font:"24px MessageFont",fill:"#000",align:"left",boundsAlignH:"left",boundsAlignV:"top",wordWrap:!0,wordWrapWidth:800};e.show=n}(Messages||(Messages={}));var CodeBuilding=function(e){function t(t,n,o){var i=e.call(this,t,n,o,!1)||this;if(i.model=n,i.inputEnabled=!0,i.input.pixelPerfectClick=!0,i.input.useHandCursor=!0,i.gnomeCode=[],n.initialCode)for(var a=0;a<n.initialCode.length;a++)i.gnomeCode.push(CommandType.getCommandTypeForShorthand(n.initialCode.charAt(a)));return t.add.existing(i),i}return __extends(t,e),t.prototype.select=function(){this.tint=16777045,this.selectionIndicator&&this.selectionIndicator.destroy(),this.selectionIndicator=this.game.add.graphics(0,0),this.selectionIndicator.beginFill(16776960,.4),this.selectionIndicator.moveTo(-WorldConstants.BLOCK_WIDTH/2,-1e3),this.selectionIndicator.lineTo(-WorldConstants.BLOCK_WIDTH/2,-15),this.selectionIndicator.lineTo(0,WorldConstants.BLOCK_HEIGHT/2-15),this.selectionIndicator.lineTo(WorldConstants.BLOCK_WIDTH/2,-15),this.selectionIndicator.lineTo(WorldConstants.BLOCK_WIDTH/2,-1e3),this.selectionIndicator.endFill(),this.addChild(this.selectionIndicator)},t.prototype.deselect=function(){this.tint=16777215,this.selectionIndicator&&this.selectionIndicator.destroy()},t.getLibraryColor=function(e){switch(e){case 0:return"orange";case 1:return"purple";case 2:return"green";default:return"red"}},t}(GameObject),House=function(e){function t(n,o){var i=e.call(this,n,o,t.determineSprite(o.direction))||this;if(i.model=o,i.inputEnabled=!0,i.input.pixelPerfectClick=!0,i.input.useHandCursor=!0,i.delay=o.delay,i.gnomeCode=[],o.initialCode)for(var a=0;a<o.initialCode.length;a++)i.gnomeCode.push(CommandType.getCommandTypeForShorthand(o.initialCode.charAt(a)));return n.add.existing(i),i}return __extends(t,e),t.determineSprite=function(e){switch(e){case Direction.NE:return"house_ne";case Direction.NW:return"house_nw";case Direction.SE:return"house_se";case Direction.SW:return"house_sw"}},t}(CodeBuilding),GameWorld=function(){function e(e){this.game=e,this.hasWon=!1,this.blockGroup=e.add.group(e.world,"blocks"),this.entityGroup=e.add.group(e.world,"entities"),this.startCodeTimer()}return e.prototype.loadLevel=function(e){var t=this.game.cache.getJSON(e).LEVEL_DEFINITION;this.loadLevelFromDefinition(t)},e.prototype.loadLevelFromDefinition=function(e){var t=this;this.selectedBuildingGnomeGhost&&(this.selectedBuildingGnomeGhost.destroy(),this.selectedBuildingGnomeGhost=null),this.selectedBuilding=null,this.hasWon=!1,this.blockGroup.removeAll(!0),this.entityGroup.removeAll(!0),this.gnomes=[],this.selectionListener&&this.selectionListener(),this.level=new Level(e),this.level.renderStage(this.blockGroup),this.level.renderObjects(this.entityGroup),e.introMessage&&Messages.show(this.game,e.introMessage),this.gnomeCode=new GnomeCode(this.level.libraries.map(function(e){return e.gnomeCode})),this.level.codeBuildings.forEach(function(e){e.events.onInputDown.add(function(){return t.selectCodeBuilding(e)})}),this.determineEntityZIndices()},e.prototype.selectCodeBuilding=function(e){this.selectedBuilding&&this.selectedBuilding.deselect(),this.selectedBuildingGnomeGhost&&(this.selectedBuildingGnomeGhost.destroy(),this.selectedBuildingGnomeGhost=null),this.selectedBuilding=e,this.selectedBuilding.select(),this.selectionListener&&this.selectionListener(e,this.level.libraries),e instanceof House&&(this.selectedBuildingGnomeGhost=this.spawnGnome(e),this.selectedBuildingGnomeGhost.alpha=.3,this.game.add.tween(this.selectedBuildingGnomeGhost).to({y:this.selectedBuildingGnomeGhost.y-3},1e3,Phaser.Easing.Sinusoidal.InOut,!0).yoyo(!0,0).repeat(-1))},e.prototype.doGnomeAction=function(e){var t=e.location.getNeighbor(e.direction),n=this.level.getBlock(t),o=this.gnomes.filter(function(e){return e.location.equals(t)}),i=o[0];this.level.doObjectAction(t,e)||(e.floating||n!==WorldConstants.BlockType.WATER?!e.floating&&i&&e.wateringCan&&!i.wateringCan&&(e.wateringCan=!1,i.wateringCan=!0):e.wateringCan=!0)},e.prototype.tryMove=function(e){var t=e.location.getNeighbor(e.direction);return!(this.gnomes.filter(function(e){return e.location.equals(t)}).length||!this.level.pointIsPassable(t)||(e.walkTo(t),this.determineEntityZIndices(),this.level.getBlock(t)===WorldConstants.BlockType.SWAMP&&e.delayed++,0))},e.prototype.killGnome=function(e,t){this.gnomes.splice(this.gnomes.indexOf(e),1),this.entityGroup.remove(e),this.game.world.add(e),e.die(t)},e.prototype.resetGame=function(){var e=this;this.gnomes.forEach(function(t){e.killGnome(t,CauseOfDeath.CODE_RAN_OUT)}),this.level.softReset()},e.prototype.spawnGnomes=function(){var e=this;this.selectedBuildingGnomeGhost&&(this.selectedBuildingGnomeGhost.destroy(),this.selectedBuildingGnomeGhost=null),this.level.houses.forEach(function(t){var n=e.spawnGnome(t);e.entityGroup.add(n),e.gnomes.push(n),e.determineEntityZIndices()})},e.prototype.spawnGnome=function(e){return new Gnome(this.game,e.model.positionX+Direction.getXDelta(e.model.direction),e.model.positionY+Direction.getYDelta(e.model.direction),e.model.direction,this.addDelay(e.gnomeCode,e.delay))},e.prototype.getIfRunning=function(){return this.gnomes.length>0},e.prototype.addDelay=function(e,t){for(var n=[],o=0;o<t;o++)n.push(new Command(CommandType.DELAY));return n.concat(e)},e.prototype.determineEntityZIndices=function(){this.entityGroup.customSort(function(e,t){var n=e.location.x+e.location.y,o=t.location.x+t.location.y;return n>o?1:n<o?-1:0})},e.prototype.startCodeTimer=function(){var e=this,t=this.game.time.create();t.loop(WorldConstants.TURN_LENGTH_IN_MILLIS,function(){e.gnomeCode.executeNextCommand(e,e.gnomes),!e.hasWon&&e.level.checkVictory()&&e.winLevel()}),t.start()},e.prototype.winLevel=function(){var e=this;this.hasWon=!0,Messages.show(this.game,"Good work! Click here to continue",{callback:function(){e.loadNextLevel()}}),SaveGame.setLevel(this.level.nextLevel)},e.prototype.getIfLevelIsWon=function(){return this.hasWon},e.prototype.loadNextLevel=function(){this.level.nextLevel?this.loadLevel(this.level.nextLevel):this.game.state.start("menu")},e}(),WATERFALL_X_OFFSET_RIGHT=47,WATERFALL_X_OFFSET_LEFT=67,WATERFALL_Y_OFFSET=-97,Level=function(){function e(e){this.objectMap={},this.houses=[],this.codeBuildings=[],this.libraries=[];var t=JSON.parse(JSON.stringify(e));this.layout=t.layout,this.objectModels=t.objects,this.victoryConditions=t.victoryConditions,this.nextLevel=t.nextLevel}return e.prototype.pointIsPassable=function(e){var t=this.getObject(e);return!t||t.passable},e.prototype.getPointCauseOfDeath=function(e,t){var n=this.getBlock(e);if(null===n)return CauseOfDeath.FALLING;if(n===WorldConstants.BlockType.WATER||!t&&n===WorldConstants.BlockType.SWAMP)return CauseOfDeath.DROWNING;var o=this.getObject(e);return o&&o.causeOfDeath?o.causeOfDeath:CauseOfDeath.NOTHING},e.prototype.getBlock=function(e){return void 0===this.layout[e.y]||void 0===this.layout[e.y][e.x]?null:this.layout[e.y][e.x]},e.prototype.getObject=function(e){return this.objectMap[e.toString()]},e.prototype.checkVictory=function(){if(!this.victoryConditions)return!1;for(var e=0,t=this.victoryConditions;e<t.length;e++){var n=t[e];if(!VictoryCondition.check(n,this.objectModels))return!1}return!0},e.prototype.doObjectAction=function(e,t){var n=this.objectMap[e.toString()];return!!n&&n.doAction(t)},e.prototype.softReset=function(){for(var e in this.objectMap)this.objectMap.hasOwnProperty(e)&&this.objectMap[e].softReset()},e.prototype.renderStage=function(e){for(var t=this.layout.length,n=this.layout[0].length,o=0;o<t;o++)for(var i=0;i<n;i++){var a=this.layout[o][i];this.renderBlock(e,i,o,a),a===WorldConstants.BlockType.WATER&&(o===t-1&&this.renderWaterFall(e,i,o,!0),i===n-1&&this.renderWaterFall(e,i,o,!1))}},e.prototype.renderObjects=function(e){for(var t=0;t<this.objectModels.length;t++){var n=this.objectModels[t],o=this.renderObject(e.game,n);e.add(o),this.objectMap[new MapPoint(n.positionX,n.positionY).toString()]=o}},e.prototype.renderObject=function(e,t){var n=ObjectType.instantiate(e,t,this.libraries.length);return n instanceof House&&this.houses.push(n),n instanceof CodeBuilding&&(this.codeBuildings.push(n),"LIBRARY"===n.model.type&&this.libraries.push(n)),n},e.prototype.renderBlock=function(e,t,n,o){var i=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(new MapPoint(t,n)),a=e.game.add.sprite(i.x,i.y,WorldConstants.SPRITE_SHEET,this.getBlockSprite(o));a.anchor.y=1,e.add(a)},e.prototype.renderWaterFall=function(e,t,n,o){var i=WorldConstants.COORDINATE_TRANSFORMER.map_to_screen(new MapPoint(t,n)),a=new Phaser.Sprite(e.game,i.x+(o?WATERFALL_X_OFFSET_LEFT:WATERFALL_X_OFFSET_RIGHT),i.y+WATERFALL_Y_OFFSET,WorldConstants.SPRITE_SHEET);a.anchor.y=0,a.anchor.x=0,o&&(a.scale.x=-1),a.animations.add("flow",Phaser.Animation.generateFrameNames("waterfall_",0,3)),a.alpha=.5,a.animations.play("flow",10,!0),e.add(a)},e.prototype.getBlockSprite=function(e){switch(e){case WorldConstants.BlockType.GRASS:return"stage_block";case WorldConstants.BlockType.WATER:return"water_block";case WorldConstants.BlockType.DESERT:return"desert_block";case WorldConstants.BlockType.STONE:return"stone_block";case WorldConstants.BlockType.SWAMP:default:return"stage_block"}},e}(),States;!function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(e){this.initialLevel=e||"tutorial_level_1"},n.prototype.create=function(){var t=this;this.game.camera.setPosition(-400,-300),this.game.stage.backgroundColor=16777215,this.initializeEditor(),this.drawSpawnButton(),this.addHotKeys(),document.getElementById("innerCodeEditor").addEventListener("click",function(e){return t.handleCommandClick(e)}),this.gameWorld=new GameWorld(this.game),this.gameWorld.selectionListener=function(n,o){t.selectedCodeBuilding=n,e.PlayState.cleanupCommandButtonBar(),n&&t.initializeButtons(o),t.showCodeInEditor()},"string"==typeof this.initialLevel?this.gameWorld.loadLevel(this.initialLevel):this.gameWorld.loadLevelFromDefinition(this.initialLevel)},n.prototype.addHotKeys=function(){var e=this,t=document.getElementById("innerCodeEditor");this.game.input.keyboard.addKey(Phaser.Keyboard.ENTER).onDown.add(function(){e.gameWorld.getIfLevelIsWon()?e.gameWorld.loadNextLevel():(e.gameWorld.resetGame(),e.gameWorld.spawnGnomes())},this),this.game.input.keyboard.addKey(Phaser.Keyboard.TAB).onDown.add(function(){if(!e.selectedCodeBuilding)return void e.gameWorld.selectCodeBuilding(e.gameWorld.level.codeBuildings[0]);var t=e.gameWorld.level.codeBuildings.indexOf(e.selectedCodeBuilding);t+1>=e.gameWorld.level.codeBuildings.length?e.gameWorld.selectCodeBuilding(e.gameWorld.level.codeBuildings[0]):e.gameWorld.selectCodeBuilding(e.gameWorld.level.codeBuildings[t+1])},this),window.addEventListener("keydown",function(o){if(e.selectedCodeBuilding){console.log("hi");var i=e.selectedCodeBuilding.gnomeCode,a=e.selectedCodeBuilding.model.sizeLimit;n.removePlaceholders(t),(8===o.keyCode||46===o.keyCode)&&i.length>0&&(t.removeChild(t.children[i.length-1]),i.pop()),37===o.keyCode&&i.length<a&&(n.appendCommandToGui(t,CommandType.LEFT),i.push(new Command(CommandType.LEFT))),38===o.keyCode&&i.length<a&&(n.appendCommandToGui(t,CommandType.WALK),i.push(new Command(CommandType.WALK))),39===o.keyCode&&i.length<a&&(n.appendCommandToGui(t,CommandType.RIGHT),i.push(new Command(CommandType.RIGHT))),(40===o.keyCode||32===o.keyCode)&&i.length<a&&(n.appendCommandToGui(t,CommandType.ACT),i.push(new Command(CommandType.ACT))),o.keyCode>=49&&o.keyCode<58&&i.length<a&&e.gameWorld.level.libraries.length>o.keyCode-49&&(n.appendCommandToGui(t,CommandType.CALL_ROUTINE,o.keyCode-49),i.push(new Command(CommandType.CALL_ROUTINE,[o.keyCode-49]))),o.keyCode>=97&&o.keyCode<106&&i.length<a&&e.gameWorld.level.libraries.length>o.keyCode-97&&(n.appendCommandToGui(t,CommandType.CALL_ROUTINE,o.keyCode-97),i.push(new Command(CommandType.CALL_ROUTINE,[o.keyCode-97]))),n.appendPlaceholders(t,e.selectedCodeBuilding.model.sizeLimit-i.length)}})},n.prototype.shutdown=function(){e.PlayState.cleanupCommandButtonBar(),document.getElementById("mushroomSelectionHint").style.display="none";var t=document.getElementById("gnomeCodeEditor");t.style.display="none";var n=t.cloneNode(!0);t.parentNode.replaceChild(n,t)},n.cleanupCommandButtonBar=function(){var e=document.getElementById("gnomeCodeButtons"),t=e.cloneNode();e.parentNode.replaceChild(t,e),e.style.display="none",document.getElementById("mushroomSelectionHint").style.display="none"},n.prototype.initializeButtons=function(e){var t=this,o=document.getElementById("gnomeCodeButtons");o.style.display="block",o.addEventListener("click",function(e){return t.handleCommandButtonClick(e)}),Sortable.create(o,{group:{name:"gnomeCode",pull:"clone",put:!1},sort:!1}),n.appendCommandToGui(o,CommandType.WALK),n.appendCommandToGui(o,CommandType.LEFT),n.appendCommandToGui(o,CommandType.RIGHT),n.appendCommandToGui(o,CommandType.ACT);for(var i=0;i<e.length;i++)n.appendCommandToGui(o,CommandType.CALL_ROUTINE,i)},n.prototype.initializeEditor=function(){var e=this,t=document.getElementById("innerCodeEditor");this.codeEditorSortable=Sortable.create(t,{group:{name:"gnomeCode",pull:!1,put:!0},animation:150,filter:".commandPlaceholder",onSort:function(o){var i=e.selectedCodeBuilding.gnomeCode,a="innerCodeEditor"===o.from.id?i.splice(o.oldIndex,1)[0]:e.parseCommandFromMouseEvent(o);if(i.splice(o.newIndex,0,a),n.removePlaceholders(t),i.length>e.selectedCodeBuilding.model.sizeLimit)for(i.splice(e.selectedCodeBuilding.model.sizeLimit);t.children.length>e.selectedCodeBuilding.model.sizeLimit;)t.removeChild(t.children.item(e.selectedCodeBuilding.model.sizeLimit));n.appendPlaceholders(t,e.selectedCodeBuilding.model.sizeLimit-i.length)}})},n.prototype.parseCommandFromMouseEvent=function(e){var t=parseInt(e.item.dataset.commandType);return e.item.dataset.libraryIndex?new Command(t,[parseInt(e.item.dataset.libraryIndex)]):new Command(t)},n.prototype.showCodeInEditor=function(){var e=document.getElementById("gnomeCodeEditor");if(e.style.display=this.selectedCodeBuilding?"block":"none",document.getElementById("mushroomSelectionHint").style.display=this.selectedCodeBuilding?"none":"block",this.selectedCodeBuilding){e.classList.toggle("readonly",this.selectedCodeBuilding.model.readonly),e.classList.toggle("editable",!this.selectedCodeBuilding.model.readonly),this.updateCommandsLabel();var t=document.getElementById("innerCodeEditor");t.innerHTML="",this.codeEditorSortable.options.disabled=this.selectedCodeBuilding.model.readonly,this.selectedCodeBuilding.gnomeCode.forEach(function(e){n.appendCommandToGui(t,e.type,e.args[0])}),n.appendPlaceholders(t,this.selectedCodeBuilding.model.sizeLimit-this.selectedCodeBuilding.gnomeCode.length)}},n.prototype.updateCommandsLabel=function(){var e=document.getElementById("codeEditorLabel");if(this.selectedCodeBuilding.model.readonly)"LIBRARY"===this.selectedCodeBuilding.model.type?e.innerText="This library routine can't be changed":e.innerText="This gnome's routine can't be changed";else{var t=this.selectedCodeBuilding.gnomeCode.length;t=t>0?t:0,this.selectedCodeBuilding.delay?e.innerText="This building has a delay of "+this.selectedCodeBuilding.delay:e.innerText="",n.appendPlaceholders(document.getElementById("innerCodeEditor"),this.selectedCodeBuilding.model.sizeLimit-t)}},n.prototype.drawSpawnButton=function(){var e=this;this.drawButton(94,10,"play_button",function(){e.gameWorld.resetGame(),e.gameWorld.spawnGnomes()})},n.prototype.drawButton=function(e,t,n,o){var i=this.game.add.sprite(e,t,WorldConstants.SPRITE_SHEET,n);return i.inputEnabled=!0,i.fixedToCamera=!0,i.events.onInputDown.add(o,this),i.input.useHandCursor=!0,i},n.prototype.handleCommandButtonClick=function(e){var t=e.target;if(!(!t.classList.contains("commandButton")||this.selectedCodeBuilding.model.readonly||this.selectedCodeBuilding.gnomeCode.length>=this.selectedCodeBuilding.model.sizeLimit||this.gameWorld.getIfRunning())){var o=parseInt(t.dataset.commandType),i=t.dataset.libraryIndex?new Command(o,[parseInt(t.dataset.libraryIndex)]):new Command(o);this.selectedCodeBuilding.gnomeCode.push(i),n.removePlaceholders(document.getElementById("innerCodeEditor")),n.appendCommandToGui(document.getElementById("innerCodeEditor"),o,i.args[0]),this.updateCommandsLabel()}},n.prototype.handleCommandClick=function(e){var t=e.target;if(t.classList.contains("commandButton")&&!t.classList.contains("commandPlaceholder")&&!this.selectedCodeBuilding.model.readonly&&!this.gameWorld.getIfRunning()){var o=document.getElementById("innerCodeEditor"),i=Array.prototype.indexOf.call(o.children,t);this.selectedCodeBuilding.gnomeCode.splice(i,1),n.removePlaceholders(document.getElementById("innerCodeEditor")),o.removeChild(t),this.updateCommandsLabel()}},n.appendCommandToGui=function(e,t,n){var o=document.createElement("DIV");o.classList.add("commandButton","tooltipped"),o.dataset.commandType=t.toString(),o.classList.add(CommandType.imageClass(t));var i=document.createElement("SPAN");return i.classList.add("tooltip"),i.innerText=CommandType.getTooltip(t),o.appendChild(i),void 0!==n&&(o.dataset.libraryIndex=n.toString(),o.classList.add(CodeBuilding.getLibraryColor(n))),e.appendChild(o),o},n.removePlaceholders=function(e){for(var t=e.getElementsByClassName("commandPlaceholder"),n=t.length-1;n>=0;n--)e.removeChild(t[n])},n.appendPlaceholders=function(e,t){for(var n=0;n<t;n++){var o=document.createElement("DIV");o.classList.add("commandButton"),o.classList.add("commandPlaceholder"),e.appendChild(o)}},n}(Phaser.State);e.PlayState=t}(States||(States={}));var States;!function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.preload=function(){var e=this.game.width/2,t=this.game.height/2
;this.game.add.sprite(e,t,"logo").anchor.set(.5);var n=this.game.add.sprite(e,t+100,"progressBar");n.anchor.set(.5),this.load.setPreloadSprite(n),this.load.atlas(WorldConstants.SPRITE_SHEET,"assets/sprites/sprites.png","assets/sprites/sprites.json"),this.load.audio("falling_gnome_scream","assets/sound/wilhelm_scream.ogg"),this.load.audio("bubbles","assets/sound/bubbles.wav"),this.load.json("tutorial_level_1","assets/levels/tutorial_level_1.json"),this.load.json("tutorial_level_2","assets/levels/tutorial_level_2.json"),this.load.json("tutorial_level_3","assets/levels/tutorial_level_3.json"),this.load.json("tutorial_level_4","assets/levels/tutorial_level_4.json"),this.load.json("tutorial_level_5","assets/levels/tutorial_level_5.json"),this.load.json("tutorial_level_6","assets/levels/tutorial_level_6.json"),this.load.json("menu_level","assets/levels/menu_level.json"),this.load.json("test","assets/levels/example_level.json")},t.prototype.create=function(){var e=this;this.game.time.events.add(0,function(){e.game.state.start("menu")},this)},t}(Phaser.State);e.PreloadState=t}(States||(States={}));var States;!function(e){var t={font:"32px MessageFont",fill:"#ff0044",align:"center"},n=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.enteredCode="",t.handleKeyDown=function(){var e=t.game.input.keyboard.event.key,n="ETGNOMEHOME";1===e.length&&(t.enteredCode+=e.toUpperCase(),n.substr(0,t.enteredCode.length)!==t.enteredCode&&(t.enteredCode=""),n===t.enteredCode&&Messages.show(t.game,"Are you a wizard?\nClick here to choose a level.",{callback:function(){var e=prompt("Continue from which level?","tutorial_level_6");e&&t.game.state.start("play",!0,!1,e)}}))},t}return __extends(n,e),n.prototype.create=function(){this.game.camera.setPosition(-400,-300),this.gameWorld=new GameWorld(this.game),this.gameWorld.loadLevel("menu_level"),this.game.stage.backgroundColor=16777215,this.createMenuButton("Continue",0,-250,this.continueGame),this.createMenuButton("Start Game",-250,200,this.startGame),this.createMenuButton("Credits",340,-115,this.credits),this.createMenuImage(250,-75,"main_menu_options"),this.createMenuImage(-250,150,"main_menu_start"),this.createMenuImage(-90,-210,"main_menu_continue"),this.game.input.keyboard.onDownCallback=this.handleKeyDown},n.prototype.createMenuButton=function(e,n,o,i){var a=this.game.add.text(n,o,e,t);return a.inputEnabled=!0,a.input.useHandCursor=!0,a.events.onInputUp.add(i,this),a},n.prototype.createMenuImage=function(e,t,n){var o=this.game.add.image(e,t,WorldConstants.SPRITE_SHEET,n);return o.scale.set(.5,.5),o},n.prototype.startGame=function(){var e=this;this.gameWorld.level.houses[0].gnomeCode=[new Command(CommandType.WALK),new Command(CommandType.WALK),new Command(CommandType.ACT),new RunnableCommand(function(){return e.game.state.start("play")})],this.gameWorld.spawnGnomes()},n.prototype.continueGame=function(){var e=this;this.gameWorld.level.houses[0].gnomeCode=[new Command(CommandType.WALK),new Command(CommandType.RIGHT),new Command(CommandType.WALK),new Command(CommandType.WALK),new Command(CommandType.RIGHT),new Command(CommandType.WALK),new Command(CommandType.ACT),new RunnableCommand(function(){e.game.state.start("play",!0,!1,SaveGame.getLevel())})],this.gameWorld.spawnGnomes()},n.prototype.credits=function(){var e=this;this.gameWorld.level.houses[0].gnomeCode=[new Command(CommandType.WALK),new Command(CommandType.LEFT),new Command(CommandType.WALK),new Command(CommandType.WALK),new Command(CommandType.LEFT),new Command(CommandType.WALK),new Command(CommandType.ACT),new RunnableCommand(function(){return e.game.state.start("credits")})],this.gameWorld.spawnGnomes()},n}(Phaser.State);e.MenuState=n}(States||(States={}));var States;!function(e){var t=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return __extends(n,t),n.prototype.init=function(){this.scale.scaleMode=Phaser.ScaleManager.RESIZE,this.game.camera.bounds=null,this.game.stage.backgroundColor=16777215},n.prototype.preload=function(){this.game.load.image("progressBar","assets/images/progressbar.png"),this.game.load.image("logo","assets/images/logo.png"),this.game.state.add("preload",e.PreloadState),this.game.state.add("menu",e.MenuState),this.game.state.add("play",e.PlayState),this.game.state.add("credits",e.CreditsState)},n.prototype.create=function(){this.game.state.start("preload")},n}(Phaser.State);e.BootState=t}(States||(States={}));var Game=function(e){function t(){return e.call(this,"100","100",Phaser.AUTO,"content",null)||this}return __extends(t,e),t.prototype.start=function(){this.state.add("boot",States.BootState,!0)},t}(Phaser.Game);window.codeGarden=new Game;var Mushrooms=function(e){function t(t,n){var o=e.call(this,t,n,"mushrooms_"+n.amount,!0)||this;return o.model=n,o}return __extends(t,e),t.prototype.doAction=function(e){return!(!this.model.amount&&!e.wateringCan)&&(e.wateringCan?(e.wateringCan=!1,this.model.amount<3&&this.model.amount++):(e.floating=2,this.model.amount--),this.updateTexture(),!0)},t.prototype.determineTexture=function(){return"mushrooms_"+this.model.amount},t}(GameObject),States;!function(e){var t,n=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.prototype.create=function(){var e={font:"32px Arial",fill:"#ffd700",align:"center"};this.game.stage.backgroundColor=0;t=this.game.add.text(this.game.world.centerX,3*this.game.world.centerY,"Level Design\n\nElmer Jacobs\n\n\nDevelopment\n\nBogdán Bikics\nIris Hupkens\nWytze Roël\nJoris Slob\n\n\nCharacter Art\n\nMarco Tonino\n\n\nTesting\n\nMats Perk",e),t.anchor.set(.5),this.game.physics.arcade.enable([t]),t.body.velocity.setTo(0,-100)},n.prototype.update=function(){(t.centerY<-t.height/2||this.game.input.activePointer.isDown)&&this.game.state.start("menu")},n}(Phaser.State);e.CreditsState=n}(States||(States={}));var SaveGame;!function(e){function t(){try{return localStorage.getItem("lastLevel")}catch(e){return console.error(e),null}}function n(e){try{e?localStorage.setItem("lastLevel",e):localStorage.removeItem("lastLevel")}catch(e){console.error(e)}}e.getLevel=t,e.setLevel=n}(SaveGame||(SaveGame={}));